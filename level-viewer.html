<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Level Viewer</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css"/>
  <script defer src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <style>
    html, body { height:100%; margin:0; background:#0b0c0f; }
    body { display:flex; flex-direction:column; }
    main { flex:1; }
    #pano { width:100%; height:100%; background:#000; }
    #vrOverlay { position:fixed; inset:0; background:#000; z-index:1080; display:none; }
    #vrOverlay a-scene { width:100%; height:100%; }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark bg-dark sticky-top border-bottom border-secondary">
    <div class="container-fluid align-items-center flex-nowrap py-1">
      <button class="btn btn-sm text-white" type="button" data-bs-toggle="offcanvas" data-bs-target="#mainMenu" aria-label="Open menu">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="mx-auto text-light small">
        <a id="levelTitle" class="navbar-brand" href="#">Loading...</a>
      </div>
      <div class="d-flex gap-2">
        <button id="btnReset" class="btn btn-outline-light btn-sm">Reset</button>
        <button id="btnVR" class="btn btn-primary btn-sm">VR</button>
      </div>
    </div>
  </nav>

  <div class="offcanvas offcanvas-start text-bg-dark" tabindex="-1" id="mainMenu" data-bs-theme="dark">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title">Menu</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
      <nav class="nav flex-column">
        <a class="nav-link text-primary" href="https://github.com/HunterTTP/game-visitor">GitHub</a>
        <a class="nav-link text-primary" href="/index.html">Level Selector</a>
      </nav>
    </div>
  </div>

  <main class="container-fluid p-0">
    <div id="pano"></div>
  </main>

  <div id="vrOverlay">
    <a-scene id="vrScene" renderer="antialias: true" background="color: #000" vr-mode-ui="enabled: true">
      <a-entity camera look-controls wasd-controls="enabled:false" position="0 1.6 0"></a-entity>
      <a-sky id="vrSky" rotation="0 -90 0"></a-sky>
    </a-scene>
  </div>

  <script>
    const LEVELS = [
      { id: "wow-pano",   title: "Goldshire - Inside", pano: "panos/wow-pano.jpg" },
      { id: "wow-pano-2", title: "Goldshire - Woods",  pano: "panos/wow-pano-2.jpg" },
      { id: "level-3",  title: "Level 3",  pano: "https://picsum.photos/seed/3/4096/2048" },
      { id: "level-4",  title: "Level 4",  pano: "https://picsum.photos/seed/4/4096/2048" },
      { id: "level-5",  title: "Level 5",  pano: "https://picsum.photos/seed/5/4096/2048" },
      { id: "level-6",  title: "Level 6",  pano: "https://picsum.photos/seed/6/4096/2048" },
      { id: "level-7",  title: "Level 7",  pano: "https://picsum.photos/seed/7/4096/2048" },
      { id: "level-8",  title: "Level 8",  pano: "https://picsum.photos/seed/8/4096/2048" },
      { id: "level-9",  title: "Level 9",  pano: "https://picsum.photos/seed/9/4096/2048" },
      { id: "level-10", title: "Level 10", pano: "https://picsum.photos/seed/10/4096/2048" },
      { id: "level-11", title: "Level 11", pano: "https://picsum.photos/seed/11/4096/2048" },
      { id: "level-12", title: "Level 12", pano: "https://picsum.photos/seed/12/4096/2048" },
      { id: "level-13", title: "Level 13", pano: "https://picsum.photos/seed/13/4096/2048" },
      { id: "level-14", title: "Level 14", pano: "https://picsum.photos/seed/14/4096/2048" },
      { id: "level-15", title: "Level 15", pano: "https://picsum.photos/seed/15/4096/2048" },
      { id: "level-16", title: "Level 16", pano: "https://picsum.photos/seed/16/4096/2048" },
      { id: "level-17", title: "Level 17", pano: "https://picsum.photos/seed/17/4096/2048" },
      { id: "level-18", title: "Level 18", pano: "https://picsum.photos/seed/18/4096/2048" },
      { id: "level-19", title: "Level 19", pano: "https://picsum.photos/seed/19/4096/2048" },
      { id: "level-20", title: "Level 20", pano: "https://picsum.photos/seed/20/4096/2048" },
      { id: "level-21", title: "Level 21", pano: "https://picsum.photos/seed/21/4096/2048" },
      { id: "level-22", title: "Level 22", pano: "https://picsum.photos/seed/22/4096/2048" },
      { id: "level-23", title: "Level 23", pano: "https://picsum.photos/seed/23/4096/2048" },
      { id: "level-24", title: "Level 24", pano: "https://picsum.photos/seed/24/4096/2048" }
    ];

    const getLevelById = (id) => LEVELS.find(l => l.id === id) || LEVELS[0];

    window.addEventListener("DOMContentLoaded", () => {
      const params = new URLSearchParams(location.search);
      const level = getLevelById(params.get("id"));

      const breakpoints = {
        phone:  matchMedia("(max-width: 576px)"),
        tablet: matchMedia("(min-width: 577px) and (max-width: 992px)")
      };
      const hfovFor = () => breakpoints.phone.matches ? 55 : (breakpoints.tablet.matches ? 70 : 85);

      const viewer = pannellum.viewer("pano", {
        type: "equirectangular",
        panorama: level.pano,
        autoLoad: true,
        autoRotate: -2,
        hfov: hfovFor(),
        minHfov: 20,
        maxHfov: 95
      });

      const applyResponsiveHfov = () => viewer.setHfov(hfovFor(), false);
      [breakpoints.phone, breakpoints.tablet].forEach(mq => mq.addEventListener("change", applyResponsiveHfov));
      addEventListener("orientationchange", applyResponsiveHfov);
      addEventListener("resize", applyResponsiveHfov);

      document.getElementById("levelTitle").textContent = level.title;

      document.getElementById("btnReset").onclick = () => {
        viewer.lookAt(0, 0, hfovFor(), false);
        viewer.startAutoRotate(-2);
      };

      const btnVR = document.getElementById("btnVR");
      const vrOverlay = document.getElementById("vrOverlay");
      const vrScene = document.getElementById("vrScene");
      const vrSky = document.getElementById("vrSky");

      btnVR.addEventListener("click", () => {
        vrSky.setAttribute("src", level.pano);   // direct URL; no <a-assets> needed
        vrOverlay.style.display = "block";
        requestAnimationFrame(() => { if (vrScene.enterVR) vrScene.enterVR(); });
      });

      vrScene.addEventListener("exit-vr", () => { vrOverlay.style.display = "none"; });
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
