<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Level Viewer</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css"
    />
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"
    ></script>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        background: #0b0c0f;
      }
      body {
        display: flex;
        flex-direction: column;
      }
      main {
        flex: 1;
      }
      #pano {
        width: 100%;
        height: 100%;
        background: #000;
      }
      #vrOverlay {
        position: fixed;
        inset: 0;
        background: #000;
        z-index: 1080;
        display: none;
      }
      #vrOverlay a-scene {
        width: 100%;
        height: 100%;
      }
      .grid {
        max-height: 70vh;
        overflow: auto;
        padding: 0.5rem;
      }
      .tile {
        aspect-ratio: 1/1;
      }
      .tile img {
        width: 100%;
        height: 100%;
        border-radius: 0.7rem;
        object-fit: cover;
        display: block;
      }
    </style>
  </head>
  <body>
    <nav
      class="navbar navbar-dark bg-dark sticky-top border-bottom border-secondary"
    >
      <div class="container-fluid align-items-center flex-nowrap py-1">
        <button
          class="btn btn-sm text-white"
          type="button"
          data-bs-toggle="offcanvas"
          data-bs-target="#mainMenu"
          aria-label="Open menu"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="mx-auto text-light small">
          <a id="levelTitle" class="navbar-brand" href="#">Loading...</a>
        </div>
        <div class="d-flex gap-2">
          <button id="btnReset" class="btn btn-outline-light btn-sm">
            Reset
          </button>
          <button id="btnVR" class="btn btn-primary btn-sm">VR</button>
        </div>
      </div>
    </nav>

    <div
      class="offcanvas offcanvas-start text-bg-dark"
      tabindex="-1"
      id="mainMenu"
      data-bs-theme="dark"
      aria-labelledby="mainMenuLabel"
    >
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="mainMenuLabel">Menu</h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="offcanvas"
          aria-label="Close"
        ></button>
      </div>
      <div class="offcanvas-body">
        <div class="grid">
          <div id="levelGrid" class="row row-cols-3 g-2"></div>
        </div>
        <nav class="nav flex-column mb-3">
          <a
            class="nav-link text-primary"
            href="https://github.com/HunterTTP/game-visitor"
            >GitHub</a
          >
        </nav>
      </div>
    </div>

    <main class="container-fluid p-0">
      <div id="pano"></div>
    </main>

    <div id="vrOverlay">
      <a-scene
        id="vrScene"
        renderer="antialias: true"
        background="color: #000"
        vr-mode-ui="enabled: true"
      >
        <a-entity
          camera
          look-controls
          wasd-controls="enabled:false"
          position="0 1.6 0"
        ></a-entity>
        <a-sky id="vrSky" rotation="0 -90 0"></a-sky>
      </a-scene>
    </div>

    <script>
      const LEVELS = [
        {
          id: "wow-pano",
          title: "Goldshire - Inside",
          pano: "panos/wow-pano.jpg",
          thumb: "/panos/wow-pano-thumb.webp",
        },
        {
          id: "wow-pano-2",
          title: "Goldshire - Woods",
          pano: "panos/wow-pano-2.jpg",
          thumb: "/panos/wow-pano-2-thumb.webp",
        },
        ...Array.from({ length: 22 }, (_, i) => {
          const n = i + 3;
          return {
            id: `level-${n}`,
            title: `Level ${n}`,
            pano: `https://picsum.photos/seed/${n}/4096/2048`,
            thumb: `https://picsum.photos/seed/${n}/600/600`,
          };
        }),
      ];
      const q = (s, d = document) => d.querySelector(s);
      const getLevel = (id) => LEVELS.find((l) => l.id === id) || LEVELS[0];

      let viewer, current;

      const breakpoints = {
        phone: matchMedia("(max-width: 576px)"),
        tablet: matchMedia("(min-width: 577px) and (max-width: 992px)"),
      };
      const hfovFor = () =>
        breakpoints.phone.matches ? 55 : breakpoints.tablet.matches ? 70 : 85;

      function loadLevel(level, updateUrl = true) {
        current = level;
        if (viewer) viewer.destroy();
        viewer = pannellum.viewer("pano", {
          type: "equirectangular",
          panorama: level.pano,
          autoLoad: true,
          autoRotate: -2,
          hfov: hfovFor(),
          minHfov: 20,
          maxHfov: 95,
        });
        q("#levelTitle").textContent = level.title;
        if (updateUrl) {
          const u = new URL(location.href);
          u.searchParams.set("id", level.id);
          history.replaceState(null, "", u);
        }
      }

      function buildGrid() {
        const grid = q("#levelGrid");
        grid.innerHTML = LEVELS.map(
          (l) => `
    <div class="col tile">
      <a href="?id=${l.id}" data-level="${l.id}">
        <img loading="lazy" src="${l.thumb}" alt="${l.title}"/>
      </a>
    </div>`
        ).join("");
        grid.addEventListener("click", (e) => {
          const a = e.target.closest("a[data-level]");
          if (!a) return;
          e.preventDefault();
          loadLevel(getLevel(a.dataset.level));
          const offcanvas = bootstrap.Offcanvas.getOrCreateInstance(
            q("#mainMenu")
          );
          offcanvas.hide();
        });
      }

      addEventListener("DOMContentLoaded", () => {
        buildGrid();
        const params = new URLSearchParams(location.search);
        loadLevel(getLevel(params.get("id")), false);

        const applyResponsiveHfov = () =>
          viewer && viewer.setHfov(hfovFor(), false);
        [breakpoints.phone, breakpoints.tablet].forEach((mq) =>
          mq.addEventListener("change", applyResponsiveHfov)
        );
        addEventListener("orientationchange", applyResponsiveHfov);
        addEventListener("resize", applyResponsiveHfov);

        q("#btnReset").onclick = () => {
          viewer.lookAt(0, 0, hfovFor(), false);
          viewer.startAutoRotate(-2);
        };

        const vrOverlay = q("#vrOverlay"),
          vrScene = q("#vrScene"),
          vrSky = q("#vrSky");
        q("#btnVR").addEventListener("click", () => {
          vrSky.setAttribute("src", current.pano);
          vrOverlay.style.display = "block";
          requestAnimationFrame(() => {
            if (vrScene.enterVR) vrScene.enterVR();
          });
        });
        vrScene.addEventListener("exit-vr", () => {
          vrOverlay.style.display = "none";
        });
      });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
