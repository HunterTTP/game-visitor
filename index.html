<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Level Viewer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css" />
    <script defer src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        background: #0b0c0f;
      }
      body {
        display: flex;
        flex-direction: column;
      }
      main {
        flex: 1;
      }
      #pano {
        width: 100%;
        height: 100%;
        background: #000;
      }
      #vrOverlay {
        position: fixed;
        inset: 0;
        background: #000;
        z-index: 1080;
        display: none;
      }
      #vrOverlay a-scene {
        width: 100%;
        height: 100%;
      }
      .grid {
        max-height: 70vh;
        overflow: auto;
        padding: 0.5rem;
      }
      .tile {
        aspect-ratio: 1/1;
      }
      .tile img {
        width: 100%;
        height: 100%;
        border-radius: 0.7rem;
        object-fit: cover;
        display: block;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-dark bg-dark sticky-top border-bottom border-secondary">
      <div class="container-fluid align-items-center flex-nowrap py-1">
        <button class="btn btn-sm text-white" type="button" data-bs-toggle="offcanvas" data-bs-target="#mainMenu" aria-label="Open menu">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="mx-auto text-light small">
          <a id="levelTitle" class="navbar-brand" href="#">Loading...</a>
        </div>
        <div class="d-flex gap-2">
          <button id="btnReset" class="btn btn-outline-light btn-sm">Reset</button>
          <button id="btnVR" class="btn btn-primary btn-sm">VR</button>
        </div>
      </div>
    </nav>

    <div class="offcanvas offcanvas-start text-bg-dark" tabindex="-1" id="mainMenu" data-bs-theme="dark" aria-labelledby="mainMenuLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="mainMenuLabel">Menu</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body">
        <div class="grid mb-3">
          <div id="levelGrid" class="row row-cols-3 g-2"></div>
        </div>
        <div class="mb-3">
          <div class="d-flex gap-2">
            <select id="musicSelect" class="form-select form-select-sm"></select>
            <button id="btnMuteMusic" type="button" class="btn btn-outline-light btn-sm">
              <i class="bi bi-play-fill"></i>
            </button>
          </div>
          <div class="mt-2 d-flex align-items-center gap-2">
            <span class="text-secondary"><i class="bi bi-volume-up"></i></span>
            <input id="vol" type="range" class="form-range flex-grow-1" min="0" max="100" step="1" value="60" />
          </div>
        </div>
        <div class="mb-3">
          <a href="https://github.com/HunterTTP/game-visitor" class="text-primary text-decoration-none">GitHub</a>
        </div>
      </div>
    </div>

    <main class="container-fluid p-0">
      <div id="pano"></div>
    </main>

    <div id="vrOverlay">
      <a-scene id="vrScene" renderer="antialias: true" background="color: #000" vr-mode-ui="enabled: true">
        <a-entity camera look-controls wasd-controls="enabled:false" position="0 1.6 0"></a-entity>
        <a-sky id="vrSky" rotation="0 -90 0"></a-sky>
      </a-scene>
    </div>

    <script>
      const LEVELS = [
        {
          id: "wow-pano",
          title: "Goldshire - Inside",
          pano: "panos/wow-pano.jpg",
          thumb: "/panos/wow-pano-thumb.webp",
        },
        {
          id: "wow-pano-2",
          title: "Goldshire - Woods",
          pano: "panos/wow-pano-2.jpg",
          thumb: "/panos/wow-pano-2-thumb.webp",
        },
        ...Array.from({ length: 22 }, (_, i) => {
          const n = i + 3;
          return {
            id: `level-${n}`,
            title: `Level ${n}`,
            pano: `https://picsum.photos/seed/${n}/4096/2048`,
            thumb: `https://picsum.photos/seed/${n}/600/600`,
          };
        }),
      ];
      const SONGS = [
        {
          id: "medieval-calm",
          title: "Calming Medieval Melody",
          src: "/audio/calming-medieval-melody-398116.mp3",
        },
        {
          id: "medieval-dance",
          title: "Medieval Dance (2-min edit)",
          src: "/audio/medieval-dance-2-min-edit-medieval-music-404925.mp3",
        },
        {
          id: "nature-melody",
          title: "Melody of Nature (Main)",
          src: "/audio/melody-of-nature-main-6672.mp3",
        },
      ];
      const q = (s, d = document) => d.querySelector(s);
      const getLevel = (id) => LEVELS.find((l) => l.id === id) || LEVELS[0];

      let viewer, current;

      const breakpoints = {
        phone: matchMedia("(max-width: 576px)"),
        tablet: matchMedia("(min-width: 577px) and (max-width: 992px)"),
      };
      const hfovFor = () => (breakpoints.phone.matches ? 55 : breakpoints.tablet.matches ? 70 : 85);

      function loadLevel(level, updateUrl = true) {
        current = level;
        if (viewer) viewer.destroy();
        viewer = pannellum.viewer("pano", {
          type: "equirectangular",
          panorama: level.pano,
          autoLoad: true,
          autoRotate: -2,
          hfov: hfovFor(),
          minHfov: 20,
          maxHfov: 95,
        });
        q("#levelTitle").textContent = level.title;
        if (updateUrl) {
          const u = new URL(location.href);
          u.searchParams.set("id", level.id);
          history.replaceState(null, "", u);
        }
      }

      function buildGrid() {
        const grid = q("#levelGrid");
        grid.innerHTML = LEVELS.map(
          (l) => `
          <div class="col tile">
            <a href="?id=${l.id}" data-level="${l.id}">
              <img loading="lazy" src="${l.thumb}" alt="${l.title}"/>
            </a>
          </div>`
        ).join("");
        grid.addEventListener("click", (e) => {
          const a = e.target.closest("a[data-level]");
          if (!a) return;
          e.preventDefault();
          loadLevel(getLevel(a.dataset.level));
          const offcanvas = bootstrap.Offcanvas.getOrCreateInstance(q("#mainMenu"));
          offcanvas.hide();
        });
      }

      function initMusic() {
        const sel = q("#musicSelect"),
          btn = q("#btnMuteMusic"),
          bgm = q("#bgm"),
          vol = q("#vol");

        sel.innerHTML = SONGS.map((s) => `<option value="${s.id}">${s.title}</option>`).join("");
        bgm.muted = true;

        if (vol) {
          bgm.volume = parseInt(vol.value || "60", 10) / 100;
          vol.addEventListener("input", () => {
            bgm.volume = parseInt(vol.value, 10) / 100;
          });
        }

        const setTrack = (id, play) => {
          const t = SONGS.find((s) => s.id === id) || SONGS[0];
          if (!bgm.src.endsWith(t.src)) bgm.src = t.src;
          if (play && !bgm.muted) bgm.play().catch(() => {});
        };

        sel.onchange = () => setTrack(sel.value, true);

        btn.onclick = () => {
          bgm.muted = !bgm.muted;
          btn.innerHTML = bgm.muted ? '<i class="bi bi-play-fill"></i>' : '<i class="bi bi-stop-fill"></i>';
          if (!bgm.muted) {
            if (!bgm.src) setTrack(sel.value || SONGS[0].id, false);
            bgm.play().catch(() => {});
          } else {
            bgm.pause();
          }
        };

        setTrack(SONGS[0].id, false);
      }

      addEventListener("DOMContentLoaded", () => {
        buildGrid();
        const params = new URLSearchParams(location.search);
        loadLevel(getLevel(params.get("id")), false);

        const applyResponsiveHfov = () => viewer && viewer.setHfov(hfovFor(), false);
        [breakpoints.phone, breakpoints.tablet].forEach((mq) => mq.addEventListener("change", applyResponsiveHfov));
        addEventListener("orientationchange", applyResponsiveHfov);
        addEventListener("resize", applyResponsiveHfov);

        q("#btnReset").onclick = () => {
          viewer.lookAt(0, 0, hfovFor(), false);
          viewer.startAutoRotate(-2);
        };

        const vrOverlay = q("#vrOverlay"),
          vrScene = q("#vrScene"),
          vrSky = q("#vrSky");
        q("#btnVR").addEventListener("click", () => {
          vrSky.setAttribute("src", current.pano);
          vrOverlay.style.display = "block";
          requestAnimationFrame(() => {
            if (vrScene.enterVR) vrScene.enterVR();
          });
        });
        vrScene.addEventListener("exit-vr", () => {
          vrOverlay.style.display = "none";
        });

        initMusic();
      });
    </script>

    <audio id="bgm" preload="none" loop></audio>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
