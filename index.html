<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Game Visitor</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css"
    />
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"
    ></script>

    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        background: #0b0c0f;
      }
      body {
        display: flex;
        flex-direction: column;
      }
      main {
        flex: 1;
      }
      #pano {
        width: 100%;
        height: 100%;
        background: #000;
      }

      #vrOverlay {
        position: fixed;
        inset: 0;
        background: #000;
        z-index: 1080;
        display: none;
      }
      #vrOverlay a-scene {
        width: 100%;
        height: 100%;
      }
    </style>
  </head>
  <body>
    <nav
      class="navbar navbar-dark bg-dark sticky-top border-bottom border-secondary position-relative"
    >
      <div class="container-fluid align-items-center flex-nowrap py-1">
        <button
          class="btn btn-sm text-white"
          type="button"
          data-bs-toggle="offcanvas"
          data-bs-target="#mainMenu"
          aria-controls="mainMenu"
          aria-label="Open menu"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <div
          class="position-absolute top-50 start-50 translate-middle pe-none z-3"
        >
          <div class="dropdown pe-auto">
            <button
              class="btn btn-outline-light btn-sm dropdown-toggle"
              type="button"
              data-bs-toggle="dropdown"
              aria-expanded="false"
            >
              Select Location
            </button>
            <ul class="dropdown-menu dropdown-menu-dark">
              <li>
                <a class="dropdown-item pano-option" data-scene="wow1" href="#"
                  >Goldshire - Inside</a
                >
              </li>
              <li>
                <a class="dropdown-item pano-option" data-scene="wow2" href="#"
                  >Goldshire - Woods</a
                >
              </li>
            </ul>
          </div>
        </div>

        <div class="ms-auto d-flex gap-2">
          <button id="btnReset" class="btn btn-outline-light btn-sm">
            Reset
          </button>
          <button id="btnVR" class="btn btn-primary btn-sm">VR</button>
        </div>
      </div>
    </nav>

    <div
      class="offcanvas offcanvas-start text-bg-dark"
      tabindex="-1"
      id="mainMenu"
      aria-labelledby="mainMenuLabel"
      data-bs-theme="dark"
    >
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="mainMenuLabel">Menu</h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="offcanvas"
          aria-label="Close"
        ></button>
      </div>
      <div class="offcanvas-body">
        <nav class="nav flex-column">
          <a
            class="nav-link text-primary"
            href="https://github.com/HunterTTP/game-visitor"
            >GitHub</a
          >
          <a
            class="nav-link text-primary"
            href="/level-scroller.html"
            >Level Scroller</a
          >
        </nav>
      </div>
    </div>

    <main class="container-fluid p-0">
      <div id="pano"></div>
    </main>

    <div id="vrOverlay">
      <a-scene
        id="vrScene"
        renderer="antialias: true"
        background="color: #000"
        vr-mode-ui="enabled: true"
      >
        <a-assets>
          <img id="vr-wow1" src="panos/wow-pano.jpg" crossorigin="anonymous" />
          <img
            id="vr-wow2"
            src="panos/wow-pano-2.jpg"
            crossorigin="anonymous"
          />
        </a-assets>
        <a-entity
          camera
          look-controls
          wasd-controls="enabled:false"
          position="0 1.6 0"
        ></a-entity>
        <a-sky id="vrSky" src="#vr-wow1" rotation="0 -90 0"></a-sky>
      </a-scene>
    </div>

    <script>
      window.addEventListener("DOMContentLoaded", () => {
        const breakpoints = {
          phone: window.matchMedia("(max-width: 576px)"),
          tablet: window.matchMedia(
            "(min-width: 577px) and (max-width: 992px)"
          ),
          desktop: window.matchMedia(
            "(min-width: 993px) and (max-width: 1200px)"
          ),
          largeDesktop: window.matchMedia("(min-width: 1201px)"),
        };

        const hfovFor = () => {
          if (breakpoints.phone.matches) return 55;
          if (breakpoints.tablet.matches) return 70;
          return 85;
        };

        const minH = 20,
          maxH = 95;

        const viewer = pannellum.viewer("pano", {
          default: {
            firstScene: "wow1",
            autoLoad: true,
            autoRotate: -2,
            hfov: hfovFor(),
            minHfov: minH,
            maxHfov: maxH,
          },
          scenes: {
            wow1: { type: "equirectangular", panorama: "panos/wow-pano.jpg" },
            wow2: { type: "equirectangular", panorama: "panos/wow-pano-2.jpg" },
          },
        });

        const applyResponsiveHfov = () => viewer.setHfov(hfovFor(), false);
        Object.values(breakpoints).forEach((mq) =>
          mq.addEventListener("change", applyResponsiveHfov)
        );
        window.addEventListener("orientationchange", applyResponsiveHfov);
        window.addEventListener("resize", applyResponsiveHfov);

        const dropdownBtn = document.querySelector(
          ".dropdown .dropdown-toggle"
        );
        const setDropdownLabel = (sceneId) => {
          const item = document.querySelector(
            `.dropdown-item[data-scene="${sceneId}"]`
          );
          dropdownBtn.textContent = item
            ? item.textContent.trim()
            : "Select Location";
        };
        setDropdownLabel(viewer.getScene());

        document.getElementById("btnReset").onclick = () => {
          viewer.lookAt(0, 0, hfovFor(), false);
          viewer.startAutoRotate(-2);
          setDropdownLabel(viewer.getScene());
        };

        let autoRotating = true;
        document.querySelectorAll(".pano-option").forEach((el) => {
          el.addEventListener("click", (e) => {
            e.preventDefault();
            const scene = el.getAttribute("data-scene");
            viewer.loadScene(scene, null, null, hfovFor(), 0);
            if (autoRotating) viewer.startAutoRotate(-2);
            else viewer.stopAutoRotate();
            setDropdownLabel(scene);
          });
        });

        const btnVR = document.getElementById("btnVR");
        const vrOverlay = document.getElementById("vrOverlay");
        const vrScene = document.getElementById("vrScene");
        const vrSky = document.getElementById("vrSky");

        const syncSceneToVR = () => {
          const sceneId = viewer.getScene();
          vrSky.setAttribute("src", `#vr-${sceneId}`);
        };

        btnVR.addEventListener("click", () => {
          syncSceneToVR();
          vrOverlay.style.display = "block";
          requestAnimationFrame(() => {
            if (vrScene.enterVR) vrScene.enterVR();
          });
        });

        vrScene.addEventListener("exit-vr", () => {
          vrOverlay.style.display = "none";
        });
      });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
